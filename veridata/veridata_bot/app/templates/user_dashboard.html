{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>Dashboard: {{ instance_name }}</h1>
    <div style="display: flex; gap: 1rem; align-items: center;">
        {% include "partials/global_toggle_btn.html" %}

        <form action="/user/logout" method="post" style="margin: 0;">
            <button type="submit"
                style="background-color: var(--secondary-color); border: 1px solid var(--border-color);">Logout</button>
        </form>
    </div>
</div>

<div
    style="background-color: var(--secondary-color); padding: 1.5rem; border-radius: 0.5rem; margin-top: 2rem; border: 1px solid var(--border-color);">
    <h3 style="margin-top: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        Monthly Usage
        <span style="font-size: 0.9em; font-weight: normal; color: #94a3b8;">Resets: {{ quota.renewal }}</span>
    </h3>
    <div
        style="background-color: var(--bg-color); height: 1.5rem; border-radius: 1rem; overflow: hidden; position: relative; border: 1px solid var(--border-color);">
        {% set percentage = quota.used / quota.limit * 100 if quota.limit > 0 else 0 %}
        {% if percentage > 100 %}{% set percentage = 100 %}{% endif %}

        <div
            style="background-color: {% if percentage >= 100 %}var(--danger-color){% elif percentage > 80 %}#f59e0b{% else %}var(--primary-color){% endif %}; width: {{ percentage }}%; height: 100%; transition: width 0.3s ease;">
        </div>

        <div
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">
            {{ quota.used }} / {{ quota.limit }} Messages
        </div>
    </div>
</div>

<div style="margin-top: 2rem;">
    <h2>Active Conversations</h2>
    <p style="color: #888; margin-bottom: 1rem;">
        Here are the users currently interacting with your bot. Use the toggle to Pause (Human Handoff) or Resume the
        bot for each user.
    </p>

    <table>
        <thead>
            <tr>
                <th>Phone Number</th>
                <th>Last Active</th>
                <th style="text-align: center;">Bot Status</th>
            </tr>
        </thead>
        <tbody id="sessions-body">
            {% for session in sessions %}
            {% include "partials/user_session_row.html" %}
            {% else %}
            <tr>
                <td colspan="3" style="text-align: center; padding: 2rem; color: #666;">
                    No active sessions found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}